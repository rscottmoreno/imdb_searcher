<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>IMDB Searcher</title>
    <style>
      :root {
        --bg: #f4f6fa;
        --surface: #ffffff;
        --surface-soft: #f9fbff;
        --text: #131a27;
        --muted: #5f6f88;
        --border: #dde3ef;
        --primary: #0f6fff;
        --primary-soft: #e8f1ff;
        --accent: #f5c518;
        --shadow: 0 22px 50px rgba(16, 24, 40, 0.1);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Inter", "Segoe UI", Arial, sans-serif;
        color: var(--text);
        background:
          radial-gradient(circle at top right, rgba(15, 111, 255, 0.12), transparent 50%),
          radial-gradient(circle at top left, rgba(245, 197, 24, 0.15), transparent 40%),
          var(--bg);
      }

      .page {
        width: min(1120px, 92%);
        margin: 0 auto;
        padding: 2rem 0 3rem;
      }

      .hero {
        border: 1px solid var(--border);
        background: linear-gradient(125deg, #0f1f4d, #123375 52%, #13438a);
        color: #eef4ff;
        border-radius: 24px;
        padding: 2rem;
        box-shadow: var(--shadow);
      }

      .hero h1 {
        margin: 0;
        font-size: clamp(1.7rem, 4vw, 2.8rem);
        letter-spacing: -0.02em;
      }

      .hero h1 span {
        color: var(--accent);
      }

      .hero p {
        margin: 0.65rem 0 0;
        max-width: 760px;
        color: #d3def2;
      }

      .layout {
        margin-top: 1rem;
        display: grid;
        gap: 1rem;
        grid-template-columns: 320px 1fr;
        align-items: start;
      }

      .panel {
        border: 1px solid var(--border);
        border-radius: 20px;
        background: var(--surface);
        box-shadow: var(--shadow);
      }

      .filters {
        padding: 1rem;
        position: sticky;
        top: 1rem;
      }

      .filters h2,
      .results-header h2 {
        margin: 0 0 0.75rem;
        font-size: 1.08rem;
      }

      .field {
        margin-bottom: 0.9rem;
      }

      .field label {
        display: block;
        font-size: 0.86rem;
        color: var(--muted);
        margin-bottom: 0.35rem;
        font-weight: 600;
      }

      .hint {
        margin-top: 0.35rem;
        color: var(--muted);
        font-size: 0.8rem;
        line-height: 1.35;
      }

      .hint a {
        color: var(--primary);
        text-decoration: none;
      }

      input[type="number"],
      input[type="text"] {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 0.62rem 0.7rem;
        font-size: 0.95rem;
      }

      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 0.45rem;
      }

      .chip {
        border: 1px solid var(--border);
        background: var(--surface-soft);
        color: var(--muted);
        border-radius: 999px;
        font-size: 0.82rem;
        padding: 0.35rem 0.68rem;
        cursor: pointer;
        user-select: none;
      }

      .chip.active {
        border-color: #c8dbff;
        background: var(--primary-soft);
        color: var(--primary);
      }

      .toggle-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.35rem;
        color: var(--muted);
        font-size: 0.9rem;
      }

      .actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.6rem;
      }

      button {
        border: 1px solid transparent;
        border-radius: 12px;
        padding: 0.65rem 0.8rem;
        font-size: 0.95rem;
        font-weight: 700;
        cursor: pointer;
      }

      .btn-primary {
        background: var(--primary);
        color: #fff;
      }

      .btn-secondary {
        border-color: var(--border);
        color: var(--muted);
        background: #fff;
      }

      .results-wrap {
        padding: 1rem;
      }

      .results-header {
        display: flex;
        justify-content: space-between;
        align-items: end;
        gap: 0.8rem;
        border-bottom: 1px solid var(--border);
        padding-bottom: 0.8rem;
      }

      .status {
        color: var(--muted);
        font-size: 0.9rem;
      }

      .cards {
        margin-top: 1rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
        gap: 0.85rem;
      }

      .card {
        border: 1px solid var(--border);
        border-radius: 14px;
        overflow: hidden;
        background: #fff;
      }

      .poster {
        width: 100%;
        aspect-ratio: 2 / 3;
        object-fit: cover;
        display: block;
        background: #edf2fb;
      }

      .card-content {
        padding: 0.85rem;
      }

      .card h3 {
        margin: 0;
        font-size: 1rem;
      }

      .meta {
        margin-top: 0.35rem;
        color: var(--muted);
        font-size: 0.88rem;
      }

      .badges {
        margin-top: 0.7rem;
        display: flex;
        gap: 0.45rem;
        flex-wrap: wrap;
      }

      .badge {
        border-radius: 999px;
        font-size: 0.78rem;
        padding: 0.23rem 0.5rem;
      }

      .badge-rating {
        background: #fff6d8;
        color: #816300;
      }

      .badge-votes {
        background: #eef5ff;
        color: #35609c;
      }

      .empty {
        padding: 1.1rem;
        border: 1px dashed var(--border);
        border-radius: 14px;
        color: var(--muted);
        font-size: 0.95rem;
      }

      @media (max-width: 900px) {
        .layout {
          grid-template-columns: 1fr;
        }

        .filters {
          position: static;
        }
      }
    </style>
  </head>
  <body>
    <main class="page">
      <section class="hero">
        <h1><span>IMDB</span> Searcher</h1>
        <p>
          Browse English-language films with modern filters: pick one or more genres, set the oldest year, choose minimum vote count,
          and get results sorted automatically by highest IMDb rating.
        </p>
      </section>

      <section class="layout">
        <aside class="panel filters">
          <h2>Filters</h2>

          <div class="field">
            <label for="apiKeyInput">TMDB API key</label>
            <input id="apiKeyInput" type="text" placeholder="Paste your TMDB v3 API key" />
            <p class="hint">
              Stored only in your browser. Get one at
              <a href="https://www.themoviedb.org/settings/api" target="_blank" rel="noopener noreferrer">themoviedb.org/settings/api</a>.
            </p>
          </div>

          <div class="field">
            <label for="titleSearch">Title keyword (optional)</label>
            <input id="titleSearch" type="text" placeholder="e.g. dark, matrix, king" />
          </div>

          <div class="field">
            <label>Genres</label>
            <div class="chips" id="genreChips"></div>
          </div>

          <div class="field">
            <label for="oldestYear">Oldest year (optional)</label>
            <input id="oldestYear" type="number" min="1900" max="2100" placeholder="e.g. 1990" />
          </div>

          <div class="field">
            <div class="toggle-row">
              <input id="useMinVotes" type="checkbox" checked />
              <label for="useMinVotes">Use minimum votes</label>
            </div>
            <input id="minVotes" type="number" min="0" step="1000" value="10000" />
          </div>

          <div class="actions">
            <button id="applyButton" class="btn-primary" type="button">Apply</button>
            <button id="resetButton" class="btn-secondary" type="button">Reset</button>
          </div>
        </aside>

        <section class="panel results-wrap">
          <div class="results-header">
            <h2>Top Rated Results</h2>
            <p class="status" id="statusText">Loading films...</p>
          </div>
          <div id="results" class="cards"></div>
        </section>
      </section>
    </main>

    <script>
      const TMDB_BASE = "https://api.themoviedb.org/3";
      const POSTER_BASE = "https://image.tmdb.org/t/p/w500";
      const HARDCODED_TMDB_API_KEY = "1b555bc4652d451432b8e8c9083634f5";
      const HARDCODED_TMDB_READ_TOKEN =
        "eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIxYjU1NWJjNDY1MmQ0NTE0MzJiOGU4YzkwODM2MzRmNSIsIm5iZiI6MTc3MDc2MjY4MS4yMDk5OTk4LCJzdWIiOiI2OThiYjFiOTM0NzFhZTVmN2Q4ODViY2MiLCJzY29wZXMiOlsiYXBpX3JlYWQiXSwidmVyc2lvbiI6MX0.Lv7-2QopxSV6XRPNwCy0WGToTSu_oyBrHyCaUatwKME";

      const fallbackGenres = [
        { id: 28, name: "Action" },
        { id: 12, name: "Adventure" },
        { id: 16, name: "Animation" },
        { id: 35, name: "Comedy" },
        { id: 80, name: "Crime" },
        { id: 99, name: "Documentary" },
        { id: 18, name: "Drama" },
        { id: 10751, name: "Family" },
        { id: 14, name: "Fantasy" },
        { id: 27, name: "Horror" },
        { id: 9648, name: "Mystery" },
        { id: 878, name: "Sci-Fi" },
        { id: 53, name: "Thriller" }
      ];

      const resultsEl = document.getElementById("results");
      const statusEl = document.getElementById("statusText");
      const chipsEl = document.getElementById("genreChips");
      const apiKeyEl = document.getElementById("apiKeyInput");
      const titleSearchEl = document.getElementById("titleSearch");
      const oldestYearEl = document.getElementById("oldestYear");
      const useMinVotesEl = document.getElementById("useMinVotes");
      const minVotesEl = document.getElementById("minVotes");
      const applyButtonEl = document.getElementById("applyButton");
      const resetButtonEl = document.getElementById("resetButton");

      let currentGenres = [...fallbackGenres];
      const selectedGenres = new Set();
      const storedKey = localStorage.getItem("tmdbApiKey") || "";
      apiKeyEl.value = storedKey || HARDCODED_TMDB_API_KEY;

      function formatVotes(votes) {
        return Number(votes || 0).toLocaleString("en-US");
      }

      function renderGenreChips() {
        chipsEl.innerHTML = "";
        currentGenres.forEach((genre) => {
          const chip = document.createElement("button");
          chip.type = "button";
          chip.className = "chip";
          chip.textContent = genre.name;
          if (selectedGenres.has(genre.id)) {
            chip.classList.add("active");
          }
          chip.addEventListener("click", () => {
            if (selectedGenres.has(genre.id)) {
              selectedGenres.delete(genre.id);
              chip.classList.remove("active");
            } else {
              selectedGenres.add(genre.id);
              chip.classList.add("active");
            }
          });
          chipsEl.appendChild(chip);
        });
      }

      function renderMovies(list) {
        resultsEl.innerHTML = "";
        if (!list.length) {
          resultsEl.innerHTML = '<div class="empty">No movies matched these filters. Try a lower vote threshold or fewer genres.</div>';
          return;
        }

        list.forEach((movie) => {
          const genreNames = (movie.genre_ids || [])
            .map((id) => currentGenres.find((g) => g.id === id)?.name)
            .filter(Boolean)
            .join(", ");
          const poster = movie.poster_path
            ? `${POSTER_BASE}${movie.poster_path}`
            : "https://via.placeholder.com/500x750?text=No+Poster";

          const card = document.createElement("article");
          card.className = "card";
          card.innerHTML = `
            <img class="poster" src="${poster}" alt="${movie.title} poster" loading="lazy" />
            <div class="card-content">
              <h3>${movie.title}</h3>
              <p class="meta">${movie.release_date?.slice(0, 4) || "N/A"} • ${genreNames || "Unknown genre"} • English</p>
              <div class="badges">
                <span class="badge badge-rating">TMDB ${Number(movie.vote_average || 0).toFixed(1)}</span>
                <span class="badge badge-votes">${formatVotes(movie.vote_count)} votes</span>
              </div>
            </div>
          `;
          resultsEl.appendChild(card);
        });
      }

      async function tmdbGet(path, extraParams = {}) {
        const params = new URLSearchParams(extraParams);
        if (!HARDCODED_TMDB_READ_TOKEN) {
          params.set("api_key", apiKeyEl.value.trim() || HARDCODED_TMDB_API_KEY);
        }

        const response = await fetch(`${TMDB_BASE}${path}?${params.toString()}`, {
          headers: HARDCODED_TMDB_READ_TOKEN
            ? {
                Authorization: `Bearer ${HARDCODED_TMDB_READ_TOKEN}`,
                Accept: "application/json"
              }
            : undefined
        });
        return response;
      }

      async function fetchGenres(apiKey) {
        const response = await tmdbGet("/genre/movie/list", { language: "en-US", api_key: apiKey });
        if (!response.ok) {
          throw new Error("Could not load genres from TMDB.");
        }
        const data = await response.json();
        currentGenres = Array.isArray(data.genres) && data.genres.length ? data.genres : fallbackGenres;
        renderGenreChips();
      }

      async function applyFilters() {
        const apiKey = apiKeyEl.value.trim() || HARDCODED_TMDB_API_KEY;
        if (!apiKey) {
          statusEl.textContent = "Add your TMDB API key to load live data.";
          renderMovies([]);
          return;
        }

        localStorage.setItem("tmdbApiKey", apiKey);

        const titleQuery = titleSearchEl.value.trim().toLowerCase();
        const oldestYear = Number(oldestYearEl.value);
        const useVotes = useMinVotesEl.checked;
        const minVotes = Number(minVotesEl.value || 10000);
        const selectedGenreCsv = [...selectedGenres].join(",");

        const params = new URLSearchParams({
          api_key: apiKey,
          include_adult: "false",
          include_video: "false",
          language: "en-US",
          sort_by: "vote_average.desc",
          with_original_language: "en",
          vote_count_gte: useVotes ? String(minVotes) : "0",
          page: "1"
        });

        if (oldestYearEl.value) {
          params.set("primary_release_date.gte", `${oldestYear}-01-01`);
        }
        if (selectedGenreCsv) {
          params.set("with_genres", selectedGenreCsv);
        }

        statusEl.textContent = "Loading live movies...";

        try {
          const pagesToLoad = 3;
          const requests = [];
          for (let i = 1; i <= pagesToLoad; i += 1) {
            const pageParams = new URLSearchParams(params);
            pageParams.set("page", String(i));
            requests.push(tmdbGet("/discover/movie", Object.fromEntries(pageParams.entries())));
          }

          const responses = await Promise.all(requests);
          responses.forEach((res) => {
            if (!res.ok) {
              throw new Error("Failed to fetch live movie data.");
            }
          });

          const payloads = await Promise.all(responses.map((res) => res.json()));
          let merged = payloads.flatMap((payload) => payload.results || []);

          if (titleQuery) {
            merged = merged.filter((movie) => movie.title?.toLowerCase().includes(titleQuery));
          }

          merged = merged.sort((a, b) => {
            if (b.vote_average !== a.vote_average) return b.vote_average - a.vote_average;
            return b.vote_count - a.vote_count;
          });

          statusEl.textContent = `Showing ${merged.length} English film${merged.length === 1 ? "" : "s"}, sorted by highest rated.`;
          renderMovies(merged);
        } catch (error) {
          statusEl.textContent = "Unable to load live data. Check API key and try again.";
          renderMovies([]);
          console.error(error);
        }
      }

      function resetFilters() {
        selectedGenres.clear();
        titleSearchEl.value = "";
        oldestYearEl.value = "";
        useMinVotesEl.checked = true;
        minVotesEl.value = "10000";
        renderGenreChips();
      }

      apiKeyEl.addEventListener("change", async () => {
        const key = apiKeyEl.value.trim();
        if (!key) {
          currentGenres = [...fallbackGenres];
          renderGenreChips();
          return;
        }
        try {
          await fetchGenres(key);
        } catch {
          currentGenres = [...fallbackGenres];
          renderGenreChips();
        }
      });

      applyButtonEl.addEventListener("click", applyFilters);
      resetButtonEl.addEventListener("click", () => {
        resetFilters();
        applyFilters();
      });
      titleSearchEl.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          applyFilters();
        }
      });
      oldestYearEl.addEventListener("change", applyFilters);
      minVotesEl.addEventListener("change", applyFilters);
      useMinVotesEl.addEventListener("change", applyFilters);

      renderGenreChips();
      const bootKey = storedKey || HARDCODED_TMDB_API_KEY;
      if (bootKey) {
        fetchGenres(bootKey).catch(() => {
          currentGenres = [...fallbackGenres];
          renderGenreChips();
        });
      }
      applyFilters();
    </script>
  </body>
</html>
